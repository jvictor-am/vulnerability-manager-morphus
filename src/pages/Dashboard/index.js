// Tela inicial após autenticação
// (http://vulnerability-manager-jv.herokuapp.com/dashboard)

import React, { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';
import { Card, Icon } from 'semantic-ui-react';

import Highcharts from 'highcharts';
import HighchartsReact from 'highcharts-react-official';
import highcharts3d from 'highcharts/highcharts-3d';

import './styles.css';

import api from '~/services/api';

highcharts3d(Highcharts);

export default function Dashboard() {
  const [thosts, setThosts] = useState({});
  const [tvuln, setTvuln] = useState({});
  const [riskavg, setRiskavg] = useState('');
  const [severity, setSeverity] = useState({});
  const [tophosts, setTophosts] = useState([]);

  // useEffect para realizar, assim que a página é exibida, as chamadas de API
  // necessárias para obtenção dos dados que irão ser utilizados no dashboard

  useEffect(() => {
    async function loadDashboard() {
      const totalHosts = await api.get('/api/dashboard/cards/asset');

      const totalVuln = await api.get('/api/dashboard/cards/vulnerability');

      const riskAverage = await api.get('/api/dashboard/cards/risk');

      const sevVuln = await api.get('/api/dashboard/charts/severity');

      const topTenHosts = await api.get('/api/dashboard/charts/top-assets');

      setThosts(totalHosts.data);
      setTvuln(totalVuln.data);
      setRiskavg(riskAverage.data);
      setSeverity(Object.entries(sevVuln.data));
      setTophosts(topTenHosts.data.map((item) => Object.values(item)));
    }

    loadDashboard();
  }, []);

  // constante com as opções que serão repassadas para o gráfico 3D de severidade

  const severityOptions = {
    series: [
      {
        colorByPoint: true,
        // color: '#ff4600',
        data: severity,
        dataLabels: {
          enabled: true,
          color: '#000',
          align: 'center',
          format: '{point.y}',
          style: {
            fontSize: '13px',
            fontFamily: 'Roboto',
          },
        },
      },
    ],
    legend: {
      enabled: false,
    },
    yAxis: {
      min: 0,
      title: {
        text: 'Quantidade',
        margin: 30,
        style: {
          fontFamily: 'Roboto',
          fontWeight: 'bold',
        },
      },
    },
    title: {
      text: 'Vulnerabilidade(s) não corrigida(s) por severidade',
      style: {
        fontSize: '20px',
        fontFamily: 'Roboto',
        fontWeight: 'bold',
      },
    },
    chart: {
      type: 'column',
      width: 800,
      height: 300,
      options3d: {
        enabled: true,
        alpha: 5,
        beta: 25,
        depth: 100,
        viewDistance: 25,
      },
    },
    xAxis: {
      type: 'category',
      labels: {
        rotation: -45,
        style: {
          fontSize: '13px',
          fontFamily: 'Roboto',
          fontWeight: 'bold',
        },
      },
    },
    tooltip: {
      pointFormat: '<b>{point.y} vulnerabilidade(s)</b>',
    },
  };

  // constante com as opções que serão repassadas para o gráfico 3D de top Hosts

  const topHostsOptions = {
    series: [
      {
        color: '#ff4600',
        data: tophosts,
        dataLabels: {
          enabled: true,
          color: '#000',
          align: 'center',
          format: '{point.y}',
          style: {
            fontSize: '13px',
            fontFamily: 'Roboto',
          },
        },
      },
    ],
    legend: {
      enabled: false,
    },
    yAxis: {
      min: 0,
      title: {
        text: 'Quantidade',
        margin: 30,
        style: {
          fontFamily: 'Roboto',
          fontWeight: 'bold',
        },
      },
    },
    title: {
      text: 'Top 10 Hosts mais vulneráveis',
      style: {
        fontSize: '20px',
        fontFamily: 'Roboto',
        fontWeight: 'bold',
      },
    },
    chart: {
      type: 'column',
      width: 800,
      height: 300,
      options3d: {
        enabled: true,
        alpha: 5,
        beta: 25,
        depth: 100,
        viewDistance: 25,
      },
    },
    xAxis: {
      labels: {
        enabled: false,
      },
      title: {
        text: 'Hosts',
        margin: 30,
        style: {
          fontFamily: 'Roboto',
          fontWeight: 'bold',
        },
      },
    },
    tooltip: {
      pointFormat: '<b>{point.y} vulnerabilidade(s)</b>',
    },
  };

  return (
    <>
      <Card.Group>
        <Card>
          <Card.Content>
            <Link to="/hosts">
              <Icon name="server" size="big" />
            </Link>
            <Card.Header>Total de Hosts</Card.Header>
            <Card.Meta>{thosts.asset_count}</Card.Meta>
            <br />
            <Card.Header>Total de Hosts Vulneráveis</Card.Header>
            <Card.Meta>{thosts.vulnerable_asset_count}</Card.Meta>
            <span>Clique no ícone para ver detalhes</span>
          </Card.Content>
        </Card>
        <Card>
          <Card.Content>
            <Link to="/vulnerabilities">
              <Icon name="bug" size="big" />
            </Link>
            <Card.Header>Total de Vulnerabilidades</Card.Header>
            <Card.Meta>{tvuln.vuln_count}</Card.Meta>
            <br />
            <Card.Header>Total de Vulnerabilidades ativas</Card.Header>
            <Card.Meta>{tvuln.active_vuln_count}</Card.Meta>
            <span>Clique no ícone para ver detalhes</span>
          </Card.Content>
        </Card>
        <Card>
          <Card.Content>
            <Icon name="line graph" size="big" />
            <Card.Header>Média de Risco dos Hosts</Card.Header>
            <Card.Meta className="avg" textAlign="center">
              {riskavg.risk_avg}
            </Card.Meta>
          </Card.Content>
        </Card>
      </Card.Group>

      <Card fluid>
        <Card.Content>
          <HighchartsReact highcharts={Highcharts} options={severityOptions} />
        </Card.Content>
      </Card>

      <Card fluid>
        <Card.Content>
          <HighchartsReact highcharts={Highcharts} options={topHostsOptions} />
        </Card.Content>
      </Card>
    </>
  );
}
